## Context

Zera 当前使用 Casdoor 作为 SSO/IAM 服务，但只实现了单向同步（Casdoor → Zera）。用户通过 CAS 协议登录时，会在 Zera 中自动创建或更新用户记录。

然而，Zera 后台创建的本地用户无法反向同步到 Casdoor，导致：
- 这些用户无法使用 CAS 统一登录入口
- 用户数据在两个系统间不一致
- 管理员需要在两个地方分别维护用户

### 相关利益方
- 系统管理员：需要在 Zera 后台统一管理所有用户
- 终端用户：希望通过 SSO 统一入口登录
- DevOps：需要减少系统间数据不一致问题

## Goals / Non-Goals

### Goals
- 实现 Zera → Casdoor 的用户同步（创建/更新/删除）
- 提供同步开关配置，允许管理员选择是否启用
- 使用 Casdoor 官方 Go SDK 进行 API 调用
- 处理同步失败情况，提供日志和可选的重试机制

### Non-Goals
- 不做实时双向同步（避免循环更新问题）
- 不同步角色/权限到 Casdoor（Casdoor 和 Zera 权限体系不同）
- 不支持批量历史数据迁移（需手动操作或单独脚本）
- 不修改现有 Casdoor → Zera 同步逻辑

## Decisions

### 1. 使用 Casdoor Go SDK

**决定**: 使用官方 `github.com/casdoor/casdoor-go-sdk` 而非直接调用 REST API

**理由**:
- 官方维护，API 变更时会同步更新
- 提供类型安全的用户结构体
- 内置认证和错误处理

**替代方案**:
- 直接调用 Casdoor REST API：更灵活但需要自己维护 API 兼容性

### 2. 同步触发时机

**决定**: 在用户服务的 CRUD 操作中同步触发

**理由**:
- 实现简单，变更即时生效
- 便于在同一事务中处理

**替代方案**:
- 异步队列：更解耦但增加复杂度
- 定时任务：延迟高，不适合实时性要求

### 3. 同步开关设计

**决定**: 在 CASConfig 中增加 `sync_to_casdoor` 布尔字段

**理由**:
- 复用现有配置存储机制
- 管理员可在 CAS 设置页面统一配置

### 4. 同步失败处理

**决定**: 记录错误日志但不回滚本地操作

**理由**:
- 本地用户管理优先于同步
- 避免因 Casdoor 服务不可用导致 Zera 用户管理功能中断

**替代方案**:
- 强制同步成功：可能导致功能不可用
- 后台重试队列：增加复杂度，未来可增强

### 5. 用户标识映射

**决定**: 使用 Zera 用户的 `username` 作为 Casdoor 用户的 `name`

**理由**:
- username 在 Zera 中唯一
- Casdoor 也以 name 作为用户唯一标识

### 6. 密码同步策略

**决定**: 创建用户时同步密码，更新时可选同步

**理由**:
- 用户创建时必须有密码才能在 Casdoor 登录
- 密码更新需要明确意图，避免意外覆盖

## Risks / Trade-offs

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| Casdoor 服务不可用 | 同步失败 | 本地操作不受影响，记录日志供后续排查 |
| 用户名冲突 | Casdoor 中已存在同名用户 | 创建前检查，返回明确错误信息 |
| 密码泄露风险 | 密码明文传输到 Casdoor | 使用 HTTPS/内网通信，Casdoor 自行哈希存储 |
| SDK 版本兼容 | API 变更导致同步失败 | 锁定 SDK 版本，定期升级测试 |

## Migration Plan

1. **Phase 1 - 配置准备**: 扩展 CASConfig 添加 SDK 凭证字段，默认禁用同步
2. **Phase 2 - SDK 集成**: 添加 Casdoor SDK 客户端封装
3. **Phase 3 - 同步实现**: 在用户服务中集成同步逻辑
4. **Phase 4 - 前端更新**: 更新 CAS 设置页面
5. **Phase 5 - 验证**: 在开发环境测试完整流程

**回滚策略**: 将 `sync_to_casdoor` 设为 false 即可禁用同步，无数据回滚需求

## Open Questions

1. 是否需要支持同步失败后的后台重试机制？（当前决定：不需要，后续增强）
2. 是否需要同步用户头像到 Casdoor？（当前决定：是，作为可选字段）
3. CAS 用户（auth_provider=cas）是否也同步回 Casdoor？（当前决定：否，避免循环）
